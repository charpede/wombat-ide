<?xml version="1.0" encoding="UTF-8"?>
<project name="wombat-ide" default="dist">
	<description>
		Wombat aims to be a simple cross-platform IDE for writing Scheme programs in a classroom environment.
	</description>
	
	<property name="revision" value="178" />
	<property name="jar-name" value="Wombat-${revision}.jar" />
	
	<property name="src-dir" location="src" />
	<property name="build-dir" location="build" />
	<property name="dist-dir" location="dist" />
	<property name="lib-dir" location="lib" />
	
	<property name="libs" value="idw-gpl.jar kawa-1.11.jar" />
	
	<path id="classpath">
		<fileset dir="${lib-dir}">
			<include name="*.jar"/>
		</fileset>
	</path>

	<!-- compile java files to class files -->
	<target name="compile" description="compile the source ">
		<delete dir="${build-dir}" />
		<mkdir dir="${build-dir}" />
		<replace file="${src-dir}/wombat/Wombat.java" token="{REVISION}" value="@{revision}" />

		<javac srcdir="${src-dir}" destdir="${build-dir}" classpathref="classpath" />
	</target>

	<!-- create a jar containing just the wombat code --> 
	<target name="dist" depends="compile" description="generate the distribution">
		<mkdir dir="${dist-dir}"/>
		<copy todir="${dist-dir}">
			<fileset dir="${lib-dir}"/>
		</copy>
		<jar jarfile="${dist-dir}/${jar-name}" basedir="${build-dir}">
			<manifest>
				<attribute name="Main-Class" value="wombat.Wombat" />
				<attribute name="Class-Path" value="${libs}" />
			</manifest>
		</jar>
	</target>
	
	<!-- sign all jars in the distribution directory -->
	<!-- TODO: make this work -->
	<target name="sign" depends="dist" description="sign the jars">
		<signjar alias="testonly" keystore="testkeystore" storepass="apacheant" lazy="true">
		  <path>
		    <fileset dir="${dist-dir}" includes="${dist-dir}/*.jar" />
		  </path>
		</signjar>
	</target>
	
	<!-- deploy to webstart -->
	<target name="deploy" depends="dist,sign" description="deploy to webstart">
		<tstamp>
			<format property="date" pattern="d MMMM yyyy" />
		</tstamp>
		
		<replace file="${dist-dir}/index.htm" token="{DATE}" value="@{date}" />
		<replace file="${dist-dir}/index.htm" token="{REVISION}" value="@{revision}" />
		<replace file="${dist-dir}/wombat.jnlp" token="{REVISION}" value="@{revision}" />
		
		<input message="Password for C211 account:" addproperty="scp-passphrase">
		      <handler classname="org.apache.tools.ant.input.SecureInputHandler" />
		</input>
		
		<scp todir="c211@tank.cs.indiana.edu:~/cgi/wombat/" passphrase="${scp-passphrase}">
			<fileset dir="${dist-dir}">
				<include name="*.jar" />
				<include name="index.htm" />
				<include name="wombat.jnlp" />
			</fileset>
		</scp>
	</target>
	
	<!-- clean everything up -->
	<target name="clean" description="remove all of the extra files / directories">
		<delete dir="${build-dir}" />
		<delete>
			<fileset dir="${dist-dir}" includes="*.jar"/>
		</delete>
	</target>
	
	<!-- build a distribution and run it -->
	<target name="run" depends="dist" description="build and run">
		<java dir="${dist-dir}" jar="${dist-dir}/${jar-name}" fork="true" failonerror="true" />
	</target>
</project>
